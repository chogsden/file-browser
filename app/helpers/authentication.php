<?PHP	// AUTHENTICATION MODULE TO ACCESS SECURE SECTIONS:	$authenticated = false;	$cookie_set = 0;	$login_ctrl = 0;	$password = '';	$password_arr = array();	$user_id = 0;	$auth_arr = array(0,0);	$login_message = '&nbsp;';  	// IF LOGGING OUT, CLEAR COOKIE:	if($authenticate_request == 'signout') {		setcookie($cookie_name, "", time() - 3600,"/".$root_dir."/",$domain);		$_GET['section'] = '';		$_GET['var'] = '';	// ELSE IF ALREADY LOGGED IN, RESET COOKIE:	} elseif(isset($_COOKIE[$cookie_name]) AND preg_replace(array('@-.*@'),'',$_COOKIE[$cookie_name])==$sess_id) {		$page_load = $section_page;		$cookie_set = 1;		$authenticated = true;		$cookie_name_arr = explode('-',$_COOKIE[$cookie_name]);		$user_id = $cookie_name_arr[1];		$user_admin = $cookie_name_arr[2];		$user_name = $cookie_name_arr[3];		setcookie($cookie_name, $sess_id.'-'.$user_id.'-'.$user_admin.'-'.$user_name, time()+3600,"/".$root_dir."/",$domain);//		echo($user_id);		if($maintenance == true AND $user_admin == 0) {			$auth_arr = array(9,9);		}	}	// IF SECTION SHOULD BE SECURE AND COOKIE IS NOT SET:	if ($cookie_set==0) {	    $user_name = '';		$user_array = array();		// CHECK USERNAME ENTRY:		if(isset($_POST['user'])) {			$login_ctrl = 1;			mysql_connect($dbserver, $dbuser, $dbpass) or exit();		    mysql_query('SET NAMES utf8');		    $qry = 'SELECT * FROM '.$tables['users'].' WHERE username="'.$_POST['user'].'" AND active = 1 '.$authenticate_filter;			$res = mysql_query($qry);			if(!$res) {//				echo($qry);				die();			} else {		        while($row = mysql_fetch_array($res, MYSQL_ASSOC)) {		        	$user_array[$row['username']] = $row;		        }	        		        	if(count($user_array) == 1) {	        		// CHECK USERNAME ENTRY:	        		$auth_arr[0] = 1;//		        	print_r($user_array);	        		$stored_pw = $user_array[$_POST['user']]['encrypted_password'];//		        	echo($stored_pw);	        			        		// CHECK PASSWORD ENTRY:	        		if (crypt($_POST['pass'], $stored_pw) == $stored_pw) {	        			$auth_arr[1] = 1;			            $user_id = $user_array[$_POST['user']]['id'];			            $user_name = $user_array[$_POST['user']]['name'];			            $user_admin = $user_array[$_POST['user']]['administrator'];	        		} 	        	}	        	if($maintenance == true AND $user_admin == 0) {					$auth_arr = array(9,9);				}			}			mysql_close();			//	print_r($auth_arr);			// AUTHENTICATE LOGIN:		  	if(implode('',$auth_arr) == '11') {				// IF USERNAME AND PASSWORD OK:				//$_SESSION['sess_id'] = session_id();				setcookie($cookie_name, $sess_id.'-'.$user_id.'-'.$user_admin.'-'.$user_name, time()+3600,"/".$root_dir."/",$domain);				$authenticated = true;				$page_load = $section_page;				// SETUP FOR USER LOG:				$user_type = $login_message;				$response = '';//				$tables['access_log'] = 'kiwa._log_access';				mysql_connect($dbserver, $dbuser, $dbpass) or exit();				mysql_query('SET NAMES utf8');				mysql_select_db('kiwa') or die('Could not select database');				require('user_log.php');				mysql_close();			} else {				$login_message = 'username or password is incorrect';			}		}	}	if(implode('',$auth_arr) == '99') {		$page_load = $login_page;		$authenticated = false;		setcookie($cookie_name, "", time() - 3600,"/".$root_dir."/",$domain);		$login_message = $maintenance_message;	}//	print_r($_COOKIE);	session_destroy();?>